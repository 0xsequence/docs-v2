import {Callout} from 'vocs/components'

# Severless Media Service

Time to complete: 20 minutes

In this guide, we'll walk you through how to store media of different types to Sequence Metadata storage using Cloudflare Workers

This can be accomplished with 6 steps
- [1. Create Collection](/guides/metadata-guide#1-create-collection-from-a-curl-request) from a cURL request one time
- [2. Create Token](/guides/metadata-guide#2-create-token-using-tokenid) create a token using a tokenID
- [3. Create Asset](/guides/metadata-guide#3-create-asset-using-tokenid) create an assetID
- [4. Store an Image](/guides/metadata-guide#4-store-image-asset) process and store an image
- [5. Update to Non-private](/guides/metadata-guide#5-update-non-private-token) Update an asset to be non-private
- [6. Publish Collection](/guides/metadata-guide#6-publish-collection-from-a-curl-request) from a cURL request one time

First follow [this section of the Severless Collectibles Guide](/guides/mint-collectibles-serverless#1-setup-cloudflare-environment-with-wrangler-cli-and-deploy-a-test) to create a cloudflare worker

<Callout type="info">
Full code for this guide can be found [here](https://github.com/0xsequence-demos/template-cloudflare-worker-metadata-store/tree/master)
</Callout>

### 1. Create Collection From A cURL Request

#### Aquire a Secret API Key
In order to use the backend service, a `Secret API` Key must be obtained

First start by accessing settings, and selecting the API Keys

![builder settings access keys](/img/builder/builder_settings_access_keys.png)

Scroll down and select `+ Add Service Account`

![builder settings add service account](/img/builder/builder_settings_add_service_account.png)

Then change the access to `write` and `confirm`

![builder settings add service account](/img/builder/builder_settings_add_service_account_confirm.png)

Finally `copy` the key and store it in your `wrangler.toml` as `JWT_ACCESS_KEY`, as you will not have access to this in the future from the Builder Console.

#### Create Collection
As a one time requirement to uploading media to the service, a collection has to be first made. By using the `Secret API Key` and `projectID` retrieved from the [Builder](https://sequence.build/)

We call the service to retrieve a `collectionID`

```shell
curl --location 'https://metadata.sequence.app/rpc/Collections/CreateCollection' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer <secret_API_key or jwt_access_key>' \
--data '{
    "projectId": <project_id>,
    "collection": {
        "metadata": {
            "name": "<name>",
            "description": "<description>",
            "external_link" : "<https://link>"
        },
        "image": "",
        "decimals": <decimals_typically_as_0>,
        "properties": null,
        "attributes": null
    }
}'
```

We then set the `collectionID` from the returned response in the `wrangler.toml` as `COLLECTION_ID`

### 2. Create Token using TokenID

```typescript

import { ethers } from 'ethers'

const randomTokenIDSpace = ethers.BigNumber.from(ethers.utils.hexlify(ethers.utils.randomBytes(20)))

// TODO: create token
const stringBody = JSON.stringify({
	"projectID": projectID,
	"collectionID": collectionID,
	"token": {
		"tokenId": String(randomTokenIDSpace),
		"name": name,
		"description": "A free lootbox mini-game available for use in any game that requires collectible rewards",
		"decimals": 0,
		"attributes": attributes
	}
});

const requestOptions = {
	method: "POST",
	headers: myHeaders,
	body: stringBody,
};

const res = await fetch(`${METADATA_URL}/rpc/Collections/CreateToken`, requestOptions)
```
### 3. Create Asset using TokenID

In the request, depending on the asset, set the `metadadaField` (assetType) to one of the following:
- `image`
- `animation_url`
- `audio`
- `video`

```typescript
// TODO: create asset
const stringBody2 = JSON.stringify({
	"projectID": projectID,
	"asset": {
		"collectionId": collectionID,
		"tokenId": String(randomTokenIDSpace),
		"metadataField": "image"
	}
});

const requestOptions2 = {
	method: "POST",
	headers: myHeaders,
	body: stringBody2,
};

const res2 = await fetch(`${METADATA_URL}/rpc/Collections/CreateAsset`, requestOptions2)
const json2: any = await res2.json()
```

### 4. Store Image Asset

With the passed in `asset.id` from the previous `json2` object

```typescript
	...
	const uploadAsset = async (env: Env, projectID: any, collectionID: any, assetID: any, tokenID: any, url: any) => {
		const response = await fetch(url);
		if (!response.ok) throw new Error(`Failed to fetch file from ${url}: ${response.statusText}`);
		const arrayBuffer = await response.arrayBuffer();
		const blob = new Blob([arrayBuffer]);

		const formData = new FormData();
		
		formData.append('file', blob, `image.png`); // You might want to dynamically determine the filename
		
		let METADATA_URL = 'https://metadata.sequence.app'

		// Construct the endpoint URL
		const endpointURL = `${METADATA_URL}/projects/${projectID}/collections/${collectionID}/tokens/${tokenID}/upload/${assetID}`;

		try {
			// Use fetch to make the request
			const fetchResponse = await fetch(endpointURL, {
			method: 'PUT',
			body: formData,
			headers: {
				'X-Access-Key': env.PROJECT_ACCESS_KEY,
				'Authorization': `Bearer ${env.JWT_ACCESS_KEY}`, // Put your token here
			},
			});
		
			// Assuming the response is JSON
			const data = await fetchResponse.json();

			return data;
		}catch(err){
			console.log(err)
		}
	}
	...
	const uploadAssetRes = await uploadAsset(env, projectID, collectionID, json2.asset.id, String(randomTokenIDSpace), imageUrl)
	...
```
Where the returned `uploadAssetRes.url` is the media file url living on Sequence servers

### 5. Update Non-private Token
Now, we make the token non-private by setting a `private` boolean to `false`

```typescript
const stringBody3 = JSON.stringify({
	"projectID": projectID,
	"collectionID": collectionID,
	"private": false,
	"tokenID": String(randomTokenIDSpace)
});

const requestOptions3 = {
	method: "POST",
	headers: myHeaders,
	body: stringBody3,
};

const res3 = await fetch(`${METADATA_URL}/rpc/Collections/UpdateToken`, requestOptions3)
const json3 = await res3.json()
```

---

### 6. Publish Collection From A cURL Request

Finally, also as a one time request, we publish the collection based on the `projectID` and `collectionID` by running the following command

```shell
curl --location 'https://metadata.sequence.app/rpc/Collections/PublishCollection' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer <secrect_API_key or jwt_access_key> \
--data '{
    "projectId": <project_id>,
    "collectionId": <collection_id>
}'
```

<Callout type="info">
Full code for this guide can be found [here](https://github.com/0xsequence-demos/template-cloudflare-worker-metadata-store/tree/master)
</Callout>